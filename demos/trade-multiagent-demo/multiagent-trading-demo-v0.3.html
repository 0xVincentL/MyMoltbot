<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Multi-Agent Trading System Demo (v0.3 · DexScreener live)</title>
  <style>
    :root{--bg:#070b10;--panel:#0c1220;--panel2:#0a0f18;--line:#1a273a;--muted:#93a7bb;--text:#eaf2fb;--accent:#6ee7ff;
      --ok:#76ff9b;--warn:#ffcc66;--bad:#ff6b6b;--chip:#101a2b;--shadow:0 20px 50px rgba(0,0,0,.35)}
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:radial-gradient(1200px 700px at 20% 0%, #0b1630 0%, var(--bg) 45%); color:var(--text)}
    header{padding:14px 18px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:12px; position:sticky;top:0;background:rgba(7,11,16,.9);backdrop-filter: blur(10px); z-index:10}
    header .left{display:flex;flex-direction:column;gap:3px}
    header h1{font-size:14px;margin:0;font-weight:700;letter-spacing:.2px}
    header .sub{font-size:12px;color:var(--muted)}
    header .right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}

    main{padding:16px 18px; display:grid; grid-template-columns: 360px 1fr; gap:14px;}
    .card{background:linear-gradient(180deg, rgba(16,26,43,.85), rgba(10,15,24,.85)); border:1px solid var(--line); border-radius:12px; padding:14px; box-shadow: var(--shadow)}
    .card.flat{box-shadow:none}

    .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .col{display:flex;flex-direction:column;gap:10px}

    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    select, button, input{width:100%;padding:10px 10px;border-radius:10px;border:1px solid #28405f;background:#0a111c;color:var(--text)}
    button{cursor:pointer;background:linear-gradient(135deg,#0e1a2b,#122a45);border-color:#33557a;font-weight:800}
    button:hover{border-color:#4b79aa}

    .chip{display:inline-flex;align-items:center;gap:8px;padding:7px 10px;border-radius:999px;background:var(--chip);border:1px solid #22344d;font-size:12px;color:var(--muted)}
    .dot{width:9px;height:9px;border-radius:50%}
    .dot.ok{background:var(--ok)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}

    .metric{display:flex;flex-direction:column;gap:6px}
    .metric .k{font-size:12px;color:var(--muted)}
    .metric .v{font-size:18px;font-weight:900}

    .grid2{display:grid;grid-template-columns: 1fr 1fr; gap:12px}

    .chart{height:240px;border-radius:12px;border:1px solid var(--line);background:radial-gradient(900px 500px at 50% 0%, rgba(110,231,255,.09) 0%, rgba(0,0,0,0) 60%), linear-gradient(180deg, rgba(8,12,18,.8), rgba(8,12,18,.6)); position:relative; overflow:hidden}
    canvas{width:100%;height:100%}
    .chart .overlay{position:absolute;left:12px;top:10px;display:flex;gap:10px;flex-wrap:wrap}

    .gauge{height:10px;border-radius:999px;background:#0b1220;border:1px solid var(--line);overflow:hidden}
    .gauge > div{height:100%;background:linear-gradient(90deg,var(--bad),var(--warn),var(--ok))}

    .section-title{font-size:12px;color:var(--muted);font-weight:800;letter-spacing:.2px;margin:0 0 8px 0}

    .timeline{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .seg{display:flex;align-items:center;gap:6px;padding:6px 8px;border-radius:10px;border:1px solid #22344d;background:#0a111c;font-size:12px;color:var(--muted)}
    .seg b{color:var(--text)}

    details{border:1px solid var(--line);border-radius:12px;background:rgba(10,15,24,.6)}
    summary{cursor:pointer;list-style:none;padding:12px 14px; font-size:12px; color:var(--muted); display:flex;justify-content:space-between;align-items:center}
    summary::-webkit-details-marker{display:none}
    pre{margin:0;padding:12px 14px;border-top:1px solid var(--line); background:rgba(8,12,18,.75); font-size:12px; line-height:1.35; white-space:pre-wrap; word-break:break-word}

    table{width:100%;border-collapse:collapse;font-size:12px}
    th,td{padding:8px 6px;border-bottom:1px solid rgba(26,39,58,.8);text-align:left}
    th{color:var(--muted);font-weight:800}
    tr:hover{background:rgba(110,231,255,.05);cursor:pointer}
    .small{font-size:12px;color:var(--muted)}
    .rightAlign{text-align:right}

    @media (max-width: 980px){
      main{grid-template-columns:1fr}
      header .right{justify-content:flex-start}
    }
  </style>
</head>
<body>
  <header>
    <div class="left">
      <h1>Multi-Agent Trading System Demo <span class="small">v0.3</span></h1>
      <div class="sub">Live data via DexScreener (read-only) · state machine first · no execution</div>
    </div>
    <div class="right">
      <span class="chip"><span class="dot" style="background:#6ee7ff"></span><span id="lastUpdate">Last update: —</span></span>
      <span class="chip"><span class="dot warn"></span><span>Demo mode: no funds / no keys</span></span>
    </div>
  </header>

  <main>
    <section class="card">
      <div class="row" style="margin-bottom:10px">
        <div class="chip" id="stateChip"><span class="dot warn" id="stateDot"></span><span id="stateText">State: —</span></div>
        <div class="chip"><span class="dot" style="background:#6ee7ff"></span><span id="confText">Conf: —</span></div>
      </div>

      <div class="row" style="gap:10px; margin-bottom:10px">
        <div style="flex:1">
          <label for="q">DexScreener search</label>
          <input id="q" value="pumpswap" placeholder="e.g. pumpswap, solana, WIF, BONK" />
        </div>
        <div style="width:120px">
          <label for="interval">Refresh</label>
          <select id="interval">
            <option value="5">5s</option>
            <option value="10" selected>10s</option>
            <option value="20">20s</option>
            <option value="30">30s</option>
          </select>
        </div>
      </div>

      <div class="row" style="gap:10px">
        <button id="refresh">Refresh now</button>
      </div>

      <div style="margin-top:14px" class="col">
        <div class="section-title">Live results (click one)</div>
        <div style="max-height:280px; overflow:auto; border:1px solid var(--line); border-radius:12px">
          <table id="tbl">
            <thead>
              <tr>
                <th>Pair</th>
                <th>Chain/Dex</th>
                <th class="rightAlign">Price</th>
                <th class="rightAlign">Vol 24h</th>
                <th class="rightAlign">Txns 24h</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div class="metric" style="margin-top:10px">
          <div class="k">Signal Score</div>
          <div class="v"><span id="score">—</span> <span class="small">/ 100</span></div>
          <div class="gauge" aria-label="signal-score"><div id="scoreBar" style="width:0%"></div></div>
        </div>

        <div class="metric">
          <div class="k">Action</div>
          <div class="v" id="action">—</div>
          <div class="small" id="risk">—</div>
        </div>

        <div>
          <div class="section-title">Why (top reasons)</div>
          <div class="timeline" id="reasons"></div>
        </div>

        <div>
          <div class="section-title">Last 24h regime mix</div>
          <div class="timeline" id="mix"></div>
        </div>

        <div class="small">
          Data source: <a href="https://dexscreener.com" target="_blank" rel="noreferrer">DexScreener</a> API (public, read-only).
        </div>
      </div>
    </section>

    <section class="col">
      <section class="card">
        <div class="row" style="margin-bottom:10px">
          <div>
            <div class="section-title">Price/Activity</div>
            <div class="small">Chart is a light visualization of current pair price + activity (not full TradingView yet).</div>
          </div>
          <div class="chip"><span class="dot" style="background:#6ee7ff"></span><span id="pairName">Pair: —</span></div>
        </div>
        <div class="chart">
          <canvas id="cv" width="1200" height="500"></canvas>
          <div class="overlay">
            <span class="chip"><span class="dot" style="background:#6ee7ff"></span><span id="sym">—</span></span>
            <span class="chip"><span class="dot" style="background:#9aa6b2"></span><span id="vol">Vol× —</span></span>
            <span class="chip"><span class="dot" style="background:#9aa6b2"></span><span id="tc">Trades× —</span></span>
            <span class="chip"><span class="dot" style="background:#9aa6b2"></span><span id="sm">Smart $ —</span></span>
            <span class="chip"><span class="dot" style="background:#9aa6b2"></span><span id="top">Top10 —h</span></span>
          </div>
        </div>
      </section>

      <section class="grid2">
        <section class="card">
          <div class="section-title">Decision Ladder</div>
          <div class="timeline">
            <div class="seg"><b>Regime</b> → <span id="ladderReg">—</span></div>
            <div class="seg"><b>Quality</b> → <span id="ladderQ">—</span></div>
            <div class="seg"><b>Action</b> → <span id="ladderA">—</span></div>
          </div>
          <div class="small" style="margin-top:10px">
            Hard constraints enforced: non-Active ⇒ no trade.
          </div>
        </section>

        <section class="card">
          <div class="section-title">Tracking (Journal)</div>
          <div class="small">When execution exists, this is where 1h/4h/24h performance + review labels go.</div>
          <div style="margin-top:10px" class="timeline">
            <div class="seg"><b>Entry state</b>: <span id="trkState">—</span></div>
            <div class="seg"><b>Entry score</b>: <span id="trkScore">—</span></div>
            <div class="seg"><b>Review</b>: Demo-only</div>
          </div>
        </section>
      </section>

      <section class="card flat">
        <details>
          <summary>
            <span>Debug: show 5-agent JSON bus (Agent01→05)</span>
            <span class="small">(for auditing + integration)</span>
          </summary>
          <pre id="debug"></pre>
        </details>
      </section>
    </section>
  </main>

<script>
  function clamp(x, a, b){ return Math.max(a, Math.min(b, x)); }
  function round(x, d=2){ const p = Math.pow(10,d); return Math.round(x*p)/p; }
  function pretty(obj){ return JSON.stringify(obj, null, 2); }

  function nowISO(){
    const d=new Date();
    return d.toISOString().replace('T',' ').slice(0,19)+'Z';
  }

  // ---- DexScreener fetch ----
  async function fetchPairs(query){
    const url = `https://api.dexscreener.com/latest/dex/search?q=${encodeURIComponent(query)}`;
    const r = await fetch(url, {cache:'no-store'});
    if (!r.ok) throw new Error(`DexScreener HTTP ${r.status}`);
    const j = await r.json();
    return (j.pairs || []);
  }

  // ---- Agent pipeline (v0.3 uses real fields when possible) ----
  function agent01_info_fromPair(pair){
    const vol24 = (pair.volume && pair.volume.h24) ? Number(pair.volume.h24) : 0;
    const vol1 = (pair.volume && pair.volume.h1) ? Number(pair.volume.h1) : 0;

    const tx24 = (pair.txns && pair.txns.h24) ? (Number(pair.txns.h24.buys||0)+Number(pair.txns.h24.sells||0)) : 0;
    const tx1  = (pair.txns && pair.txns.h1)  ? (Number(pair.txns.h1.buys||0)+Number(pair.txns.h1.sells||0)) : 0;

    // crude "change" proxies: compare last 1h scaled to 24h baseline
    const volume_change = vol24 > 0 ? round(clamp((vol1*24) / vol24, 0, 5), 2) : round(clamp(vol1/10000, 0, 5), 2);
    const trade_count_change = tx24 > 0 ? round(clamp((tx1*24) / tx24, 0, 5), 2) : round(clamp(tx1/200, 0, 5), 2);

    const priceChange24 = pair.priceChange && pair.priceChange.h24 != null ? Number(pair.priceChange.h24) : 0;
    const large_order_detected = Math.abs(priceChange24) >= 25; // placeholder heuristic

    // smart money consistency placeholder: derived from buy/sell balance in last hour
    let smart_money_consistency = 0.5;
    if (pair.txns && pair.txns.h1) {
      const b = Number(pair.txns.h1.buys||0), s = Number(pair.txns.h1.sells||0);
      const tot = b+s;
      if (tot>0) smart_money_consistency = round(clamp(Math.abs(b-s)/tot, 0, 1), 2);
    }

    // top rank duration is not directly available in DexScreener public response → placeholder 0
    const top_rank_duration_hours = 0;

    return {
      symbol: (pair.baseToken && pair.baseToken.symbol) ? pair.baseToken.symbol : (pair.pairAddress || 'UNKNOWN'),
      time_window: '24h',
      pair: {
        chainId: pair.chainId,
        dexId: pair.dexId,
        url: pair.url,
        pairAddress: pair.pairAddress,
        base: pair.baseToken,
        quote: pair.quoteToken,
        priceUsd: pair.priceUsd,
        liquidityUsd: pair.liquidity ? pair.liquidity.usd : null,
        marketCap: pair.marketCap ?? null,
        fdv: pair.fdv ?? null
      },
      features: {
        volume_change,
        trade_count_change,
        large_order_detected,
        wallet_activity_change: 0, // placeholder until on-chain wallet module is added
        top_rank_duration_hours,
        smart_money_consistency
      },
      raw: {
        volume: pair.volume || {},
        txns: pair.txns || {},
        priceChange: pair.priceChange || {}
      }
    };
  }

  function agent02_regime(info){
    const f = info.features;
    const vol = f.volume_change;
    const tc = f.trade_count_change;
    const large = !!f.large_order_detected;
    const sm = f.smart_money_consistency;

    let market_state = 'No-Info';
    let confidence = 0.60;

    const sync = (Math.abs(vol - tc) <= 0.7);
    const strong = (vol >= 1.3 && tc >= 1.3);

    if (large && (vol >= 2.0 || tc >= 2.0) && !sync) {
      market_state = 'Liquidity_Shock';
      confidence = 0.72;
    }

    if (sync && strong && sm >= 0.55) {
      market_state = 'Active';
      confidence = 0.70;
    }

    if (sync && strong && sm < 0.35) {
      market_state = 'Information_Decay';
      confidence = 0.64;
    }

    if ((tc >= 1.6 && vol < 0.9) || (sm < 0.25 && !large)) {
      market_state = 'No-Info';
      confidence = 0.78;
    }

    // mock duration mix (until we persist history)
    const states = ['Active','No-Info','Liquidity_Shock','Information_Decay'];
    const base = {Active:6, 'No-Info':14, Liquidity_Shock:3, Information_Decay:1};
    base[market_state] = clamp(base[market_state] + 2, 0, 24);
    let total = states.reduce((s,k)=>s+base[k],0);
    if (total !== 24) base['No-Info'] = clamp(base['No-Info'] + (24-total), 0, 24);
    const state_duration_24h = {};
    for (const k of states) state_duration_24h[k] = base[k] + 'h';

    return { symbol: info.symbol, market_state, confidence: round(confidence,2), state_duration_24h };
  }

  function agent03_quality(info, regime){
    const f = info.features;
    let score = 0;
    const reasons = [];
    const vol = f.volume_change;
    const tc = f.trade_count_change;
    const sm = f.smart_money_consistency;

    score += clamp((vol)*18, 0, 35);
    score += clamp((tc)*18, 0, 35);
    score += clamp(sm*18, 0, 18);
    if (f.large_order_detected) score += 5;

    if (regime.market_state === 'Active') score += 10;
    if (regime.market_state === 'No-Info') score -= 20;
    if (regime.market_state === 'Liquidity_Shock') score -= 10;
    if (regime.market_state === 'Information_Decay') score -= 8;

    score = Math.round(clamp(score, 0, 100));

    if (Math.abs(vol - tc) <= 0.7 && vol >= 1.1 && tc >= 1.1) reasons.push('volume 与 trade count 同步放大');
    if (sm >= 0.55) reasons.push('买卖结构偏一致（proxy smart money consistency）');
    if (f.large_order_detected) reasons.push('24h 波动较大（可能是冲击/事件）');
    reasons.push('市场状态：' + regime.market_state);

    let quality_label = 'Low';
    if (score >= 75) quality_label = 'High';
    else if (score >= 55) quality_label = 'Medium';

    return { symbol: info.symbol, signal_score: score, quality_label, reasons };
  }

  function agent04_decision(regime, quality){
    const state = regime.market_state;
    if (state !== 'Active') {
      const map = {
        'No-Info': {action:'AVOID', position_bias:'Neutral', risk_note:'Noise-dominant regime (No-Info). Strongly avoid.'},
        'Liquidity_Shock': {action:'AVOID', position_bias:'Neutral', risk_note:'Liquidity/event shock. Do not trade; only interpret.'},
        'Information_Decay': {action:'AVOID', position_bias:'Neutral', risk_note:'Information decaying; edge deteriorating.'}
      };
      const x = map[state] || {action:'AVOID', position_bias:'Neutral', risk_note:'Non-Active regime.'};
      return { symbol: quality.symbol, action: x.action, position_bias: x.position_bias, risk_note: x.risk_note };
    }
    if (quality.quality_label === 'High') {
      return { symbol: quality.symbol, action: 'WATCH', position_bias: 'Neutral', risk_note: 'Active + High quality. Watch for clean execution; don\'t force direction.' };
    }
    return { symbol: quality.symbol, action: 'AVOID', position_bias: 'Neutral', risk_note: 'Active but quality not high enough; avoid overtrading.' };
  }

  function agent05_tracking(regime, quality, decision){
    return {
      symbol: decision.symbol,
      entry_context: { market_state: regime.market_state, signal_score: quality.signal_score, decision: decision.action },
      post_trade_review: 'Demo mode: no trade executed. Add 1h/4h/24h outcomes when execution is integrated.'
    };
  }

  function setDot(dotEl, kind){
    dotEl.classList.remove('ok','warn','bad');
    dotEl.classList.add(kind);
  }

  function drawChart(pair, score){
    const cv=document.getElementById('cv');
    const ctx=cv.getContext('2d');
    const w=cv.width, h=cv.height;
    ctx.clearRect(0,0,w,h);

    // background grid
    ctx.strokeStyle='rgba(255,255,255,0.05)';
    for(let x=0;x<w;x+=80){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke(); }
    for(let y=0;y<h;y+=60){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke(); }

    // map score to a line slope
    const drift=(score-50)/500;

    // use current price to seed
    const seedStr = `${pair.chainId}|${pair.dexId}|${pair.pairAddress}|${Math.floor(Date.now()/60000)}`;
    let seed=2166136261;
    for (let i=0;i<seedStr.length;i++){ seed ^= seedStr.charCodeAt(i); seed = Math.imul(seed, 16777619); }
    let x = seed>>>0;
    const rand=()=>{
      x ^= x<<13; x>>>=0;
      x ^= x>>17; x>>>=0;
      x ^= x<<5; x>>>=0;
      return (x>>>0)/4294967296;
    };

    const points=[];
    let y=h*0.55;
    for(let i=0;i<120;i++){
      y += (rand()-0.5)*18 + drift*12;
      y = clamp(y, 40, h-40);
      points.push({x: (i/119)*w, y});
    }

    ctx.lineWidth=5;
    ctx.strokeStyle='rgba(110,231,255,0.18)';
    ctx.beginPath();
    points.forEach((p,i)=>{ if(i===0) ctx.moveTo(p.x,p.y); else ctx.lineTo(p.x,p.y); });
    ctx.stroke();

    ctx.lineWidth=2;
    ctx.strokeStyle='rgba(110,231,255,0.85)';
    ctx.beginPath();
    points.forEach((p,i)=>{ if(i===0) ctx.moveTo(p.x,p.y); else ctx.lineTo(p.x,p.y); });
    ctx.stroke();

    // volume bars (use 1h volume if present)
    const vol1 = pair.volume && pair.volume.h1 ? Number(pair.volume.h1) : 0;
    const barW = w/120;
    for(let i=0;i<120;i++){
      const v = rand();
      const bh = 18 + v*60;
      ctx.fillStyle = `rgba(154,166,178,${0.06 + v*0.16})`;
      ctx.fillRect(i*barW, h-bh, barW*0.7, bh);
    }

    // annotate price
    ctx.fillStyle='rgba(234,242,251,0.85)';
    ctx.font='bold 16px ui-sans-serif, system-ui';
    const p = pair.priceUsd ? Number(pair.priceUsd) : NaN;
    if (!Number.isNaN(p)) ctx.fillText(`$${p.toPrecision(6)}`, 14, h-16);
  }

  function renderPipeline(a1,a2,a3,a4,a5){
    document.getElementById('stateText').textContent = `State: ${a2.market_state}`;
    document.getElementById('confText').textContent = `Conf: ${Math.round(a2.confidence*100)}%`;

    const stateDot = document.getElementById('stateDot');
    if (a2.market_state === 'Active') setDot(stateDot,'ok');
    else if (a2.market_state === 'No-Info') setDot(stateDot,'bad');
    else setDot(stateDot,'warn');

    document.getElementById('score').textContent = a3.signal_score;
    document.getElementById('scoreBar').style.width = `${a3.signal_score}%`;

    document.getElementById('action').textContent = a4.action;
    document.getElementById('risk').textContent = a4.risk_note;

    // reasons
    const reasons = document.getElementById('reasons');
    reasons.innerHTML = '';
    (a3.reasons || []).slice(0,5).forEach(r=>{
      const el=document.createElement('div');
      el.className='seg';
      el.innerHTML = `<b>•</b> ${r}`;
      reasons.appendChild(el);
    });

    // mix
    const mix = document.getElementById('mix');
    mix.innerHTML='';
    const order=['Active','No-Info','Liquidity_Shock','Information_Decay'];
    order.forEach(k=>{
      const el=document.createElement('div');
      el.className='seg';
      el.innerHTML = `<b>${k}</b> ${a2.state_duration_24h[k] || '0h'}`;
      mix.appendChild(el);
    });

    document.getElementById('ladderReg').textContent = a2.market_state;
    document.getElementById('ladderQ').textContent = `${a3.quality_label} (${a3.signal_score})`;
    document.getElementById('ladderA').textContent = a4.action;

    document.getElementById('trkState').textContent = a5.entry_context.market_state;
    document.getElementById('trkScore').textContent = a5.entry_context.signal_score;

    // overlay
    document.getElementById('sym').textContent = a1.symbol;
    document.getElementById('vol').textContent = `Vol× ${a1.features.volume_change}`;
    document.getElementById('tc').textContent = `Trades× ${a1.features.trade_count_change}`;
    document.getElementById('sm').textContent = `Smart $ ${a1.features.smart_money_consistency}`;
    document.getElementById('top').textContent = `Top10 ${a1.features.top_rank_duration_hours}h`;

    document.getElementById('debug').textContent =
      "Agent01\n"+pretty(a1)+"\n\n"+
      "Agent02\n"+pretty(a2)+"\n\n"+
      "Agent03\n"+pretty(a3)+"\n\n"+
      "Agent04\n"+pretty(a4)+"\n\n"+
      "Agent05\n"+pretty(a5);
  }

  // ---- UI state ----
  let latestPairs = [];
  let selectedPair = null;
  let timer = null;

  function fmtUsd(x){
    const n = Number(x);
    if (!isFinite(n)) return '—';
    if (n >= 1e9) return '$' + (n/1e9).toFixed(2) + 'B';
    if (n >= 1e6) return '$' + (n/1e6).toFixed(2) + 'M';
    if (n >= 1e3) return '$' + (n/1e3).toFixed(2) + 'K';
    if (n >= 1) return '$' + n.toFixed(4);
    return '$' + n.toPrecision(4);
  }

  function fmtNum(x){
    const n = Number(x);
    if (!isFinite(n)) return '—';
    if (n >= 1e6) return (n/1e6).toFixed(2) + 'M';
    if (n >= 1e3) return (n/1e3).toFixed(2) + 'K';
    return String(Math.round(n));
  }

  function renderTable(pairs){
    const tbody=document.getElementById('tbody');
    tbody.innerHTML='';

    pairs.slice(0,25).forEach((p, idx)=>{
      const base=(p.baseToken && p.baseToken.symbol) ? p.baseToken.symbol : '—';
      const quote=(p.quoteToken && p.quoteToken.symbol) ? p.quoteToken.symbol : '—';
      const pairName = `${base}/${quote}`;
      const chainDex = `${p.chainId}/${p.dexId}`;
      const price = fmtUsd(p.priceUsd);
      const vol24 = fmtNum(p.volume && p.volume.h24 ? p.volume.h24 : 0);
      const tx24 = (p.txns && p.txns.h24) ? (Number(p.txns.h24.buys||0)+Number(p.txns.h24.sells||0)) : 0;

      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td><b>${pairName}</b><div class="small">${(p.pairAddress||'').slice(0,10)}…</div></td>
        <td>${chainDex}</td>
        <td class="rightAlign">${price}</td>
        <td class="rightAlign">${vol24}</td>
        <td class="rightAlign">${tx24}</td>
      `;
      tr.addEventListener('click', ()=>{
        selectPair(p);
      });
      tbody.appendChild(tr);

      if (!selectedPair && idx===0) {
        // auto-select first
        selectPair(p);
      }
    });
  }

  function selectPair(p){
    selectedPair = p;
    const base=(p.baseToken && p.baseToken.symbol) ? p.baseToken.symbol : '—';
    const quote=(p.quoteToken && p.quoteToken.symbol) ? p.quoteToken.symbol : '—';
    document.getElementById('pairName').textContent = `Pair: ${base}/${quote} · ${p.chainId}/${p.dexId}`;

    // run pipeline
    const a1 = agent01_info_fromPair(p);
    const a2 = agent02_regime(a1);
    const a3 = agent03_quality(a1, a2);
    const a4 = agent04_decision(a2, a3);
    const a5 = agent05_tracking(a2, a3, a4);

    renderPipeline(a1,a2,a3,a4,a5);
    drawChart(p, a3.signal_score);

    // reflect last update
    document.getElementById('lastUpdate').textContent = `Last update: ${nowISO()}`;
  }

  async function refresh(){
    const q = document.getElementById('q').value.trim() || 'pumpswap';
    try {
      const pairs = await fetchPairs(q);
      latestPairs = pairs;
      renderTable(pairs);
      // keep selectedPair if still present
      if (selectedPair) {
        const found = pairs.find(x => x.pairAddress === selectedPair.pairAddress && x.chainId === selectedPair.chainId && x.dexId === selectedPair.dexId);
        if (found) selectPair(found);
      }
    } catch (e) {
      document.getElementById('lastUpdate').textContent = `Last update: ERROR (${String(e.message||e)})`;
    }
  }

  function startTimer(){
    if (timer) clearInterval(timer);
    const sec = Number(document.getElementById('interval').value) || 10;
    timer = setInterval(refresh, sec*1000);
  }

  document.getElementById('refresh').addEventListener('click', refresh);
  document.getElementById('interval').addEventListener('change', startTimer);
  document.getElementById('q').addEventListener('change', ()=>{ selectedPair=null; refresh(); });

  // boot
  refresh();
  startTimer();
</script>
</body>
</html>
